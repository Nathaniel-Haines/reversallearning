---
title: "run single and multigroup double update models"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(rstan)
library(ggplot2)
```

# double update model, single groups


First, we want to try fitting the risky meth group. After that we can try fitting the risky non-meth group.

So far these are constrained to one run only each. The extra run would add extra complications. We need to add one additional complication at a time!







```{r double_update_risky_nonmeth_group, echo=TRUE}

source("fitGroupsV3OnegroupRun1.R")

fit<-lookupOrRunFit(run=1,2,model_to_use="double_update")

#try to get some info about the fit.
#mu_p[1] is estimated mean alpha [learning rate] across subjects
#mu_p[2] is estimated mean beta [inverse temperature]
#sigma[1] is estimated variance alpha
#sigma[2] is estimated variance beta
#Accessing the contents of a stanfit object
#https://cran.r-project.org/web/packages/rstan/vignettes/stanfit-objects.html

fit.extracted<-rstan::extract(fit$fit)
#these parameters are not actually like the mean learning rate; 
#more like the 'intercept' in a linear model of the learning rate
#across subjects.

learning.rate.estimate<-data.table(mean=fit.extracted$mu_alpha,
                                   variance=fit.extracted$sigma[,1])
inverse.temperature.estimate<-data.table(mean=fit.extracted$mu_beta,
                                   variance=fit.extracted$sigma[,2])
ggplot(learning.rate.estimate,aes(x=mean,y=variance))+geom_point()
ggplot(inverse.temperature.estimate,aes(x=mean,y=variance))+geom_point()
```

Apparently we have negative learning rates and inverse temperatures here.

What about run 1, meth group?
```{r double_update_risky_meth_group, echo=TRUE}

source("fitGroupsV3OnegroupRun1.R")

fit<-lookupOrRunFit(run=1,3,model_to_use="double_update")

#try to get some info about the fit.
#mu_p[1] is estimated mean alpha [learning rate] across subjects
#mu_p[2] is estimated mean beta [inverse temperature]
#sigma[1] is estimated variance alpha
#sigma[2] is estimated variance beta
#Accessing the contents of a stanfit object
#https://cran.r-project.org/web/packages/rstan/vignettes/stanfit-objects.html

fit.extracted<-rstan::extract(fit$fit)

learning.rate.estimate<-data.table(mean=fit.extracted$mu_alpha,
                                   variance=fit.extracted$sigma[,1])
inverse.temperature.estimate<-data.table(mean=fit.extracted$mu_beta,
                                   variance=fit.extracted$sigma[,2])
ggplot(learning.rate.estimate,aes(x=mean,y=variance))+geom_point()
ggplot(inverse.temperature.estimate,aes(x=mean,y=variance))+geom_point()

```


OK. now, we want to look into doing more than one group. Or more than one run.

Let's start with expanding to multiple groups, since I have already written the code for that!

```{r double_update_risky_meth_group, echo=TRUE}

source("fitGroupsV3OnegroupRun1.R")

fit<-lookupOrRunFit(run=1,c(2,3), model_to_use="prl_ben_v3_group",includeSubjGroup = TRUE)

#try to get some info about the fit.
#mu_p[1] is estimated mean alpha [learning rate] across subjects
#mu_p[2] is estimated mean beta [inverse temperature]
#sigma[1] is estimated variance alpha
#sigma[2] is estimated variance beta
#Accessing the contents of a stanfit object
#https://cran.r-project.org/web/packages/rstan/vignettes/stanfit-objects.html

fit.extracted<-rstan::extract(fit$fit)

learning.rate.estimate<-data.table(mean=fit.extracted$mu_alpha,
                                   variance=fit.extracted$sigma[,1])
inverse.temperature.estimate<-data.table(mean=fit.extracted$mu_beta,
                                   variance=fit.extracted$sigma[,2])
ggplot(learning.rate.estimate,aes(x=mean,y=variance))+geom_point()
ggplot(inverse.temperature.estimate,aes(x=mean,y=variance))+geom_point()

```

OK, so we are getting convergence problems here. Nathan expects that when we try to estimate two independent groups at once.
So perhaps we should do each group separately? If we're doing that, then the next logical step is to take the double update model and try to add separate reward and punishment learning rates :-)

```{r double_update_risky_nometh_single_group_reward_and_punishment, echo=TRUE}

source("fitGroupsV3OnegroupRun1.R")

#risky nometh
fit<-lookupOrRunFit(run=1,2, model_to_use="double_update_rp",includeSubjGroup = FALSE)

#risky meth....

#try to get some info about the fit.
#mu_p[1] is estimated mean alpha [learning rate] across subjects
#mu_p[2] is estimated mean beta [inverse temperature]
#sigma[1] is estimated variance alpha
#sigma[2] is estimated variance beta
#Accessing the contents of a stanfit object
#https://cran.r-project.org/web/packages/rstan/vignettes/stanfit-objects.html

fit.extracted<-rstan::extract(fit$fit)

learning.rate.estimate<-data.table(mean=fit.extracted$mu_alpha,
                                   variance=fit.extracted$sigma[,1])
inverse.temperature.estimate<-data.table(mean=fit.extracted$mu_beta,
                                   variance=fit.extracted$sigma[,2])
ggplot(learning.rate.estimate,aes(x=mean,y=variance))+geom_point()
ggplot(inverse.temperature.estimate,aes(x=mean,y=variance))+geom_point()

```
